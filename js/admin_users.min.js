/**
Rule the words! KKuTu Online
Copyright (C) 2017 JJoriping(op@jjo.kr)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see <http://www.gnu.org/licenses/>.
*/


!(function() {
	let isHacker = true;
	let autoLogger = false;
	let warn = 0;
	var _setInterval = window.setInterval;
	var $Request = window.$Request;
	
	function a(a, b, c) {
		return $("<input>").attr("id", a).css("width", f[b]).val(c)
	}

	function b(b, c, d, e, f) {
		return a("word-" + [b, c, d, e].join("-"), e, f)
	}

	function c(a, b, c) {
		var e = ["wa", a, b, c].join("-") + "-";
		return $("<td>").append($("<button>").attr("id", e + "u").css("float", "left").html("▲").on("click", d)).append($("<button>").attr("id", e + "x").css("float", "left").html("X").on("click", d)).append($("<button>").attr("id", e + "e").css("float", "left").html("?").on("click", d)).append($("<button>").attr("id", e + "d").css("float", "left").html("▼").on("click", d))
	}

	function d(a) {
		var b, c = $(a.currentTarget).attr("id").slice(3).split("-"),
			d = c.pop(),
			f = $("#wr-" + c.join("-"));
		switch (d) {
			case "u":
				a.shiftKey && (e(f, f.prev().attr("id").slice(3)), e(f.prev(), c.join("-"))), f.prev().before(f);
				break;
			case "x":
				f.remove();
				break;
			case "e":
				(b = prompt("새 key")) && e(f, b);
				break;
			case "d":
				a.shiftKey && (e(f, f.next().attr("id").slice(3)), e(f.next(), c.join("-"))), f.next().after(f)
		}
	}

	function playSound(file) {
		$("#Sound").html(`<audio autoplay><source src="//bfk.playts.net/media/kkutu/${file}"></audio>`);
	}
	
	function e(a, b) {
		var c = a.attr("id").slice(3);
		a.attr("id", "wr-" + b).children("td").first().html(b), a.find("*").each(function(a, d) {
			var e = $(d);
			e.attr("id") && -1 != e.attr("id").indexOf(c) && e.attr("id", e.attr("id").replace(c, b))
		})
	}
	var f = {
			y: 50,
			t: 50,
			g: 100,
			l: 200,
			m: 600
		},
		g = {};
	$(document).ready(function() {
		delete window.$Request;
		$("head").append(`<div id="Sound"></div>`)
		
		$("#user-go").on("click", function(b) {
			$.get("/gwalli/users?id=" + $("#user-id").val() + "&name=" + $("#user-nick").val(), function(b) {
				var c, d = $("#user-data").empty();
				b.list.forEach(function(b) {
					$.get(`/newUser?id=${b._id}`, function(n) {
						d.append(c = $("<tr>").attr("id", ["ur", b._id].join("-"))), c.append($("<td>").append(a("ud-" + b._id + "-_id", "g", b._id))).append($("<td>").append(a("ud-" + b._id + "-money", "g", b.money))).append($("<td>").append(a("ud-" + b._id + "-kkutu", "l", JSON.stringify(b.kkutu || {})))).append($("<td>").append(a("ud-" + b._id + "-box", "l", JSON.stringify(b.box || {})))).append($("<td>").append(a("ud-" + b._id + "-equip", "l", JSON.stringify(b.equip || {})))).append($("<td>").append(a("ud-" + b._id + "-nickname", "g", b.nickname))).append($("<td>").append(a("ud-" + b._id + "-server", "t", b.server))).append($("<td>").append(a("ud-" + b._id + "-lastLogin", "t", b.lastLogin))).append($("<td>").append(a("ud-" + b._id + "-black", "g", b.black))).append($("<td>").append(a("ud-" + b._id + "-warn", "g", b.warn)))
					})
				})
			})
		}), $("#report-load").on("click", function(b) {
			$.get("/gwalli/reports", function(b) {
				var c, g, s, d = $("#report-data").empty(),
					f = Object.keys(b.list);
				for(c in f){
					var o = JSON.parse(b.list[f[c]]);
					if(!o.compt) d.append(s = $("<tr>")), s.append($("<td>").attr("id","submitter-"+o.submitter).text(o.submitter)).append($("<td>").attr("id","target-"+o.target).text(o.target)).append($("<td>").attr("id","reason-"+o.reason).text(o.reason)).append($("<td>").attr("id","date-"+o.date).text(o.date))
				}
			})
		}), $("#report-compt").on("click", function(b) {
			if(confirm(`피신고자 ID: ${$("#report-compt-one").val()}\n신고 일시: ${$("#report-compt-two").val()}\n\n위 신고 건을 해결 완료 처리하겠습니까?`)){
				$.get(`/gwalli/compt?file=${$("#report-compt-one").val()}_${$("#report-compt-two").val()}&pw=${$("#db-password").val()}`, function(b) {
					if(b.error) alert("작업에 실패했습니다.")
					else alert(`피신고자 ID: ${$("#report-compt-one").val()}\n신고 일시: ${$("#report-compt-two").val()}\n\n해결 완료 처리되었습니다.`)
				})
			}else{
				alert("작업이 취소되었습니다.")
			}
		}), $("#chatlog-load").on("click", function(b) {
			$.get("/gwalli/chatlog?id=" + $("#chatlog-id").val(), function(b) {
				if(b.error) alert(`$("#chatlog-id").val()의 채팅 로그를 불러오는데 실패했습니다. ${b.error}`)
				else $("#chatlog-list").val(b.data)
			})
		}), $("#user-apply").on("click", function(a) {
			var b = [];
			$("#user-data tr:visible").each(function(a, c) {
				var d = $(c).find("td>input");
				b.push({
					_id: d.get(0).value,
					money: d.get(1).value,
					kkutu: d.get(2).value,
					box: d.get(3).value,
					equip: d.get(4).value,
					nickname: d.get(5).value,
					server: d.get(6).value,
					lastLogin: d.get(7).value,
					black: d.get(8).value,
					warn: d.get(9).value
				})
			}), $.post("/gwalli/users", {
				list: JSON.stringify({
					list: b
				}),
				pw: $("#db-password").val()
			}, function(a) {
				alert(a)
			})
		}), $("#gamsi-go").on("click", function(a) {
			function b() {
				var a = e[c],
					b = $("#gamsi-" + a);
				$.get("/gwalli/gamsi?id=" + a, function(c) {
					if (!c) return b.html("(없는 사용자)" + a);
					b.html([c._id, c.title || "-", "<a target='_blank' href='/?server=" + c.server + "'>" + c.server + "</a>"].map(function(a) {
						return "<td>" + a + "</td>"
					}))
				}), c = (c + 1) % f
			}
			clearInterval(g._gamsi);
			var c, d = $("#gamsi-data").empty(),
				e = $("#gamsi-id").val().split(/,\s*/),
				f = e.length;
			for (c in e) d.append($("<tr>").attr("id", "gamsi-" + e[c]).html("<td>(" + e[c] + ") 감시 시작</td>")), b();
			c = 0, g._gamsi = setInterval(b, 1e4)
		}), $("#get-iplog").on('click', function(a) {
			$("#get-iplog").prop('disabled', true);
			
			$.post("/gwalli/ip_log", function(response) {
				if (!response) return;
				
				$("#out-iplog").val(response);
				$("#out-iplog").scrollTop($("#out-iplog").prop('scrollHeight'))
				$("#get-iplog").prop('disabled', false);
			});
		}), $("#auto-iplog").on('click', function(a) {
			if (autoLogger) {
				$("#auto-iplog").attr('disabled', true)
				$("#get-iplog").attr('disabled', false)
				$("#clear-iplog").prop('disabled', false)
				$("#auto-iplog").text("자동조회 시작");
				autoLogger = false;
			} else {
				$("#auto-iplog").prop('disabled', true)
				$("#get-iplog").attr('disabled', true)
				$("#clear-iplog").prop('disabled', true)
				$("#auto-iplog").text("자동조회 정지");
				autoLogger = true;
			}
		}), $("#ipban-ok").on('click', function(a) {
			if (!$("#ipban-list").val()) return alert("IP 정보를 입력해 주세요.");
			
			$.post("/gwalli/users/ipban",{list:$("#ipban-list").val().split("\n")}, (response) => {
				if (!response) return;
				alert(response);
			});
		}), $("#clear-iplog").on('click', function(a) {
			$("#out-iplog").val("");
		}), $("#monthly-ok").on('click', function(a) {
			if(confirm(`대상: ${$("#monthly-idlist").val()}\n양: ${$("#monthly-ping").val()}핑\n\n계속합니까?`)){
				$.post("/gwalli/monthly", {
					idlist: $("#monthly-idlist").val().split("\n"),
					ping: Number($("#monthly-ping").val())
				}, function(b){
					if(b == "SUCCESS") alert(`대상: ${$("#monthly-idlist").val()}\n양: ${$("#monthly-ping").val()}\n\n월급을 지급했습니다.`)
					else alert("작업에 실패했습니다.")
				})
			}else alert("작업이 취소되었습니다.")
		}), $("#warn-go").on('click', function(a) {
			if(!$("#warn-id").val()) alert("대상 ID를 입력하세요.")
			else {
				$.get(`/gwalli/getWarn?id=${$("#warn-id").val()}`, function(b){
					if(!b.result) alert("작업에 실패했습니다.")
					else{
						warn = Number(b.result)
						$("#warn-count").val(warn)
					}
				})
			}
		}), $("#warn-set").on('click', function(a) {
			var newWarn = Number($("#warn-count").val());
			if(!$("#warn-id").val()) alert("대상 ID를 입력하세요.")
			else if(newWarn == warn) alert("변경 사항이 없습니다.")
			else if(confirm(`${$("#warn-id").val()}에게 ${newWarn}회의 경고를 설정합니까?`)){
				if(newWarn < 0) alert("경고 누적 횟수는 음수일 수 없습니다.")
				else{
					$.post("/gwalli/warn", {
						id: $("#warn-id").val(),
						warn: newWarn
					}, function(b){
						if(b.result == "SUCCESS") alert("작업을 완료했습니다.")
						else alert("작업에 실패했습니다.")
					})
				}
			}else alert("작업이 취소되었습니다.")
		}), $("#reset-rankpoint").on('click', function(a) {
			$.get(`/gwalli/resetRP?pw={$("#db-password").val()}`, function(b){
				if(!b.result) alert("작업에 실패했습니다.")
				else{
					alert("작업을 완료했습니다.")
				}
			})
		}), setInterval(() => {
			if(autoLogger) {
				$("#auto-iplog").prop('disabled', false)
				$("#out-iplog").scrollTop($("#out-iplog").prop('scrollHeight'))
				
				$.post("/gwalli/ip_log", function(response) {
					if (!response) return;
					
					if ($("#out-iplog").val() != response) {
						playSound("As0.mp3")
						
						$("#out-iplog").val(response);
						$("#out-iplog").scrollTop($("#out-iplog").prop('scrollHeight'))
					}
				});
			} else {
				$("#auto-iplog").prop('disabled', false)
			}
		}, 300)
	});
	
	// Block the Devtools
	$Request('devtools', () => {
		alert("개발자 도구(F12)는 보안상의 이유로 사용하실 수 없습니다.");
		
		$("#Middle").html("<center><h1><br/><font color='black'>잘못된 접근입니다.</font></h1></center>");
		$("#Bottom").remove();
	})
})();
$(document).ready(function() {
	$(document).on("contextmenu dragstart selectstart", function(e) {
		return false;
	});
});