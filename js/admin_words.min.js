/**
Rule the words! KKuTu Online
Copyright (C) 2017 JJoriping(op@jjo.kr)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
!(function() {
	let isHacker = true;
	var _setInterval = window.setInterval;
	var $Request = window.$Request;

	function a(a, b, c) {
		return $("<input>").attr("id", a).css("width", f[b]).val(c)
	}

	function b(b, c, d, e, f) {
		return a("word-" + [b, c, d, e].join("-"), e, f)
	}

	function c(a, b, c) {
		var e = ["wa", a, b, c].join("-") + "-";
		return $("<td>").append($("<button>").attr("id", e + "u").css("float", "left").html("▲").on("click", d)).append($("<button>").attr("id", e + "x").css("float", "left").html("X").on("click", d)).append($("<button>").attr("id", e + "e").css("float", "left").html("?").on("click", d)).append($("<button>").attr("id", e + "d").css("float", "left").html("▼").on("click", d))
	}

	function d(a) {
		var b, c = $(a.currentTarget).attr("id").slice(3).split("-"),
			d = c.pop(),
			f = $("#wr-" + c.join("-"));
		switch (d) {
			case "u":
				a.shiftKey && (e(f, f.prev().attr("id").slice(3)), e(f.prev(), c.join("-"))), f.prev().before(f);
				break;
			case "x":
				f.remove();
				break;
			case "e":
				(b = prompt("새 key")) && e(f, b);
				break;
			case "d":
				a.shiftKey && (e(f, f.next().attr("id").slice(3)), e(f.next(), c.join("-"))), f.next().after(f)
		}
	}

	function e(a, b) {
		var c = a.attr("id").slice(3);
		a.attr("id", "wr-" + b).children("td").first().html(b), a.find("*").each(function(a, d) {
			var e = $(d);
			e.attr("id") && -1 != e.attr("id").indexOf(c) && e.attr("id", e.attr("id").replace(c, b))
		})
	}
	var f = {
			y: 50,
			t: 50,
			g: 100,
			l: 200,
			m: 600
		},
		g = {};
	$(document).ready(function() {
		delete window.$Request;
		var wordConfirm = true;
		$("#db-ok").on("click", function(a) {
				if("~" == $("#db-theme").val().charAt()){
					$("#db-list").val(""), $.get("/gwalli/kkututheme?theme=" + $("#db-theme").val().slice(1) + "&lang=" + $("#db-lang").val(), function(a) {
						$("#db-list").val(a.list.join("\n"))
					})
				} else {
					if(/[~!@#$%^&*()_+|<>?:{}/]/.test($("#db-list").val())){
						wordConfirm = confirm("특수문자가 포함되어 있습니다! 정말 추가합니까?");
					}
					if(wordConfirm){
						$.post("/gwalli/kkutudb", {
							pw: $("#db-password").val(),
							lang: $("#db-lang").val(),
							theme: $("#db-theme").val(),
							list: $("#db-list").val()
						}, function(a) {
							alert(`단어 추가 작업을 완료했습니다.\n대상 테이블: ${$("#db-lang").val()}\n대상 주제: ${$("#db-theme").val()}\n추가한 단어: ${$("#db-list").val()}`)
						})
					} else {
						alert("작업이 취소되었습니다. 확인 후 다시 추가해주세요.")
						wordConfirm = true;
					}
				}
			}),
		$("#dbdel-ok").on("click", function(a) {
				"~" == $("#dbdel-theme").val().charAt() ? ($("#dbdel-list").val(""), $.get("/gwalli/kkututheme?theme=" + $("#dbdel-theme").val().slice(1) + "&lang=" + $("#db-lang").val(), function(a) {
					$("#dbdel-list").val(a.list.join("\n"))
				})) : $.post("/gwalli/kkutuDdb", {
					pw: $("#db-password").val(),
					lang: $("#db-lang").val(),
					theme: $("#dbdel-theme").val(),
					list: $("#dbdel-list").val()
				}, function(a) {
					alert(`단어 삭제 작업을 완료했습니다.\n대상 테이블: ${$("#db-lang").val()}\n대상 주제: ${$("#db-theme").val()}\n삭제한 단어: ${$("#db-list").val()}`)
				})
			}),
			/*$("#findword-ok").on("click", function(a) {
				var wordValue = $("#findword-value").val(),
					findType;
				if(wordValue.indexOf("~") == 0) wordValue = wordValue.split("~")[1], findType = "end";
				else if(wordValue.indexOf("~") == 1) wordValue = wordValue.split("~")[0], findType = "start";
				else alert("FAILED!");
				$.get("/gwalli/findword?lang=" + $("#db-lang").val() + "&word=" + wordValue + "&type=" + findType, function(a) {
					$("#findword-list").val(a.list.join("\n"));
					alert(`FOUND ${a.list.split('\n').length} WORDS.`);
				})
			})*/
			/*, $("#db-del").on("click", function(a) {
				"~" == $("#db-theme").val().charAt() ? ($("#db-list").val(""), $.get("/gwalli/kkututheme?theme=" + $("#db-theme").val().slice(1) + "&lang=" + $("#db-lang").val(), function(a) {
					$("#db-list").val(a.list.join("\n"))
				})) : $.post("/gwalli/kkutuDdb", {
					pw: $("#db-password").val(),
					lang: $("#db-lang").val(),
					theme: $("#db-theme").val(),
					list: $("#db-list").val()
				}, function(a) {
					alert(a)
				})
			}),*/ $.get("/gwalli/injeong", function(b) {
				var c, d = $("#injeong-data").empty();
				b.list.forEach(function(b) {
					d.append(c = $("<tr>").attr("id", ["ir", b._id.replace(/ /g, "-")].join("-"))), c.append($("<td>").append(a("ij-" + b._id + "-check", "y").attr("type", "checkbox"))).append($("<td>").append($("<a>").attr({
						target: "_blank",
						href: "https://namu.moe/w/" + encodeURI(b._id)
					}).html("이동"))).append($("<td>").append(a("ij-" + b._id + "-_id", "l", b._id))).append($("<td>").append(a("ij-" + b._id + "-theme", "g", b.theme))).append($("<td>").append(a("ij-" + b._id + "-writer", "g", b.writer))).append($("<td>").append(a("ij-" + b._id + "-createdAt", "g", b.createdAt)))
				})
			}), $("#injeong-everything").on("click", function(a) {
				$("#injeong-data input[type='checkbox']").prop("checked", !0)
			}), $("#injeong-nothing").on("click", function(a) {
				$("#injeong-data input[type='checkbox']").prop("checked", !1)
			}), $("#injeong-apply").on("click", function(a) {
				var b = [];
				$("#injeong-data tr:visible").each(function(a, c) {
					var d = $(c).find("td>input");
					b.push({
						_origin: c.id.slice(3).replace(/-/g, " "),
						_id: d.get(1).value,
						theme: d.get(2).value,
						ok: $(d.get(0)).is(":checked")
					})
				}), $.post("/gwalli/injeong", {
					list: JSON.stringify({
						list: b
					}),
					pw: $("#db-password").val()
				}, function(a) {
					alert(a)
				})
			}), $("#db-go").on("click", function(a) {
				$.get("/gwalli/kkutudb/" + $("#db-word").val() + "?lang=" + $("#db-lang").val(), function(a) {
					var d = $("#wd-data").empty(),
						e = a.type ? a.type.split(",") : [],
						f = a.theme ? a.theme.split(",") : [],
						g = a.mean ? a.mean.split(/＂[0-9]+＂/).slice(1).map(function(a) {
							return -1 == a.indexOf("［") ? [
								[a]
							] : a.split(/［[0-9]+］/).slice(1).map(function(a) {
								return a.split(/（[0-9]+）/).slice(1)
							})
						}) : [
							[
								[]
							]
						];
					$("#wd-flag").val(a.flag), g.forEach(function(a, g) {
						a.forEach(function(a, h) {
							var i, j = e.shift();
							a.forEach(function(a, e) {
								i = f.shift(), d.append($("<tr>").attr("id", ["wr", g, h, e].join("-")).append($("<td>").html([g, h, e].join("-"))).append($("<td>").append(b(g, h, e, "y", j))).append($("<td>").append(b(g, h, e, "t", i))).append($("<td>").append(b(g, h, e, "m", a))).append(c(g, h, e)))
							})
						})
					})
				})
			}), $("#word-add").on("click", function(a) {
				var d = prompt("key (-로 구분)");
				d && (d = d.split("-"), $("#wd-data").append($("<tr>").attr("id", ["wr", d[0], d[1], d[2]].join("-")).append($("<td>").html([d[0], d[1], d[2]].join("-"))).append($("<td>").append(b(d[0], d[1], d[2], "y", ""))).append($("<td>").append(b(d[0], d[1], d[2], "t", ""))).append($("<td>").append(b(d[0], d[1], d[2], "m", ""))).append(c(d[0], d[1], d[2]))))
			}), $("#db-apply").on("click", function(a) {
				var b = {
						_id: $("#db-word").val(),
						flag: $("#wd-flag").val(),
						type: [],
						theme: [],
						mean: []
					},
					c = !1;
				$("#wd-data tr").each(function(a, d) {
					var e = $(d),
						f = e.children("td").first().html().split("-"),
						g = f[0] + "-" + f[1],
						h = {
							type: $("#word-" + [f[0], f[1], f[2], "y"].join("-")).val(),
							theme: $("#word-" + [f[0], f[1], f[2], "t"].join("-")).val(),
							mean: $("#word-" + [f[0], f[1], f[2], "m"].join("-")).val()
						};
					c != g && (b.type.push(h.type), c = g), b.theme.push(h.theme), b.mean[f[0]] || (b.mean[f[0]] = []), b.mean[f[0]][f[1]] || (b.mean[f[0]][f[1]] = []), b.mean[f[0]][f[1]][f[2]] = h.mean
				}), b.type = b.type.join(","), b.theme = b.theme.join(","), b.mean = b.mean.map(function(a, b) {
					return "ko" == $("#db-lang").val() ? "＂" + (b + 1) + "＂" + a.map(function(a, b) {
						return "［" + (b + 1) + "］" + a.map(function(a, b) {
							return "（" + (b + 1) + "）" + a
						}).join("")
					}).join("") : "＂" + (b + 1) + "＂" + a
				}).join(""), $.post("/gwalli/kkutudb/" + $("#db-word").val(), {
					pw: $("#db-password").val(),
					lang: $("#db-lang").val(),
					data: JSON.stringify(b)
				}, function(a) {
					alert(a);
				})
		}), $("#hit-go").on("click", function(a) {
			$.get(`/gwalli/hitword?lang=${$("#db-lang").val()}&word=${$("#hit-word").val()}`, function(b){
				if(b.result) $("#hit-count").text(`단어 ${$("#hit-word").val()}은 ${b.result}번 사용되었습니다.`)
				else alert("작업에 실패했습니다.")
			})
		}), $("#manner-go").on("click", function(a) {
			$.get(`/gwalli/manner?lang=${$("#db-lang").val()}&pw=${$("#db-password").val()}&letter=${$("#manner-letter").val()}`, function(b){
				if(!b.error) alert(`글자 '${$("#manner-letter")}'의 한방 여부 DB를 초기화 했습니다.`)
				else alert("작업에 실패했습니다.")
			})
		}), $("#goto-edit").on("click", function(a) {
			window.scrollTo({top:1000, left:0, behavior:'auto'})
		}), $("#goto-add").on("click", function(a) {
			window.scrollTo({top:0, left:0, behavior:'auto'})
		})
	});
	
	// Block the Devtools
	$Request('devtools', () => {
		alert("개발자 도구(F12)는 보안상의 이유로 사용하실 수 없습니다.");
		
		$("#Middle").html("<center><h1><br/><font color='black'>잘못된 접근입니다.</font></h1></center>");
		$("#Bottom").remove();
	})
})();
$(document).ready(function() {
	$(document).on("contextmenu dragstart selectstart", function(e) {
		return false;
	});
});